import{Plugin as e}from"@ckeditor/ckeditor5-core";import{EventInfo as t,delay as r,env as i,uid as o,toUnit as n,DomEmitterMixin as a,global as s,Rect as d,ResizeObserver as l,createElement as g}from"@ckeditor/ckeditor5-utils";import{DomEventObserver as c,DataTransfer as p,MouseObserver as h,LiveRange as u}from"@ckeditor/ckeditor5-engine";import{Widget as m,isWidget as f}from"@ckeditor/ckeditor5-widget";import{throttle as b}from"lodash-es";import{View as _}from"@ckeditor/ckeditor5-ui";
/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */class k extends c{constructor(e){super(e),this.domEventType=["paste","copy","cut","drop","dragover","dragstart","dragend","dragenter","dragleave"];const r=this.document;function i(e){return(i,o)=>{o.preventDefault();const n=o.dropRange?[o.dropRange]:null,a=new t(r,e);r.fire(a,{dataTransfer:o.dataTransfer,method:i.name,targetRanges:n,target:o.target,domEvent:o.domEvent}),a.stop.called&&o.stopPropagation()}}this.listenTo(r,"paste",i("clipboardInput"),{priority:"low"}),this.listenTo(r,"drop",i("clipboardInput"),{priority:"low"}),this.listenTo(r,"dragover",i("dragging"),{priority:"low"})}onDomEvent(e){const t="clipboardData"in e?e.clipboardData:e.dataTransfer,r="drop"==e.type||"paste"==e.type,i={dataTransfer:new p(t,{cacheFiles:r})};"drop"!=e.type&&"dragover"!=e.type||(i.dropRange=function(e,t){const r=t.target.ownerDocument,i=t.clientX,o=t.clientY;let n;r.caretRangeFromPoint&&r.caretRangeFromPoint(i,o)?n=r.caretRangeFromPoint(i,o):t.rangeParent&&(n=r.createRange(),n.setStart(t.rangeParent,t.rangeOffset),n.collapse(!0));if(n)return e.domConverter.domRangeToView(n);return null}
/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */(this.view,e)),this.fire(e.type,e,i)}}
/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */
const D=["figcaption","li"];function v(e){let t="";if(e.is("$text")||e.is("$textProxy"))t=e.data;else if(e.is("element","img")&&e.hasAttribute("alt"))t=e.getAttribute("alt");else if(e.is("element","br"))t="\n";else{let r=null;for(const i of e.getChildren()){const e=v(i);r&&(r.is("containerElement")||i.is("containerElement"))&&(D.includes(r.name)||D.includes(i.name)?t+="\n":t+="\n\n"),t+=e,r=i}}return t}
/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */class w extends e{static get pluginName(){return"ClipboardPipeline"}init(){this.editor.editing.view.addObserver(k),this._setupPasteDrop(),this._setupCopyCut()}_setupPasteDrop(){const e=this.editor,r=e.model,i=e.editing.view,o=i.document;this.listenTo(o,"clipboardInput",((t,r)=>{"paste"!=r.method||e.model.canEditAt(e.model.document.selection)||t.stop()}),{priority:"highest"}),this.listenTo(o,"clipboardInput",((e,r)=>{const o=r.dataTransfer;let n;if(r.content)n=r.content;else{let e="";o.getData("text/html")?e=
/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */
function(e){return e.replace(/<span(?: class="Apple-converted-space"|)>(\s+)<\/span>/g,((e,t)=>1==t.length?" ":t)).replace(/<!--[\s\S]*?-->/g,"")}(o.getData("text/html")):o.getData("text/plain")&&(((a=(a=o.getData("text/plain")).replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\r?\n\r?\n/g,"</p><p>").replace(/\r?\n/g,"<br>").replace(/\t/g,"&nbsp;&nbsp;&nbsp;&nbsp;").replace(/^\s/,"&nbsp;").replace(/\s$/,"&nbsp;").replace(/\s\s/g," &nbsp;")).includes("</p><p>")||a.includes("<br>"))&&(a=`<p>${a}</p>`),e=a),n=this.editor.data.htmlProcessor.toView(e)}var a;const s=new t(this,"inputTransformation");this.fire(s,{content:n,dataTransfer:o,targetRanges:r.targetRanges,method:r.method}),s.stop.called&&e.stop(),i.scrollToTheSelection()}),{priority:"low"}),this.listenTo(this,"inputTransformation",((e,t)=>{if(t.content.isEmpty)return;const i=this.editor.data.toModel(t.content,"$clipboardHolder");0!=i.childCount&&(e.stop(),r.change((()=>{this.fire("contentInsertion",{content:i,method:t.method,dataTransfer:t.dataTransfer,targetRanges:t.targetRanges})})))}),{priority:"low"}),this.listenTo(this,"contentInsertion",((e,t)=>{t.resultRange=r.insertContent(t.content)}),{priority:"low"})}_setupCopyCut(){const e=this.editor,t=e.model.document,r=e.editing.view.document,i=(i,o)=>{const n=o.dataTransfer;o.preventDefault();const a=e.data.toView(e.model.getSelectedContent(t.selection));r.fire("clipboardOutput",{dataTransfer:n,content:a,method:i.name})};this.listenTo(r,"copy",i,{priority:"low"}),this.listenTo(r,"cut",((t,r)=>{e.model.canEditAt(e.model.document.selection)?i(t,r):r.preventDefault()}),{priority:"low"}),this.listenTo(r,"clipboardOutput",((r,i)=>{i.content.isEmpty||(i.dataTransfer.setData("text/html",this.editor.data.htmlProcessor.toData(i.content)),i.dataTransfer.setData("text/plain",v(i.content))),"cut"==i.method&&e.model.deleteContent(t.selection)}),{priority:"low"})}}!function(e,{insertAt:t}={}){if(!e||"undefined"==typeof document)return;const r=document.head||document.getElementsByTagName("head")[0],i=document.createElement("style");i.type="text/css",window.litNonce&&i.setAttribute("nonce",window.litNonce),"top"===t&&r.firstChild?r.insertBefore(i,r.firstChild):r.appendChild(i),i.styleSheet?i.styleSheet.cssText=e:i.appendChild(document.createTextNode(e))}('.ck.ck-editor__editable .ck.ck-clipboard-drop-target-position{display:inline;pointer-events:none;position:relative}.ck.ck-editor__editable .ck.ck-clipboard-drop-target-position span{position:absolute;width:0}.ck.ck-editor__editable .ck-widget:-webkit-drag>.ck-widget__selection-handle,.ck.ck-editor__editable .ck-widget:-webkit-drag>.ck-widget__type-around{display:none}.ck.ck-clipboard-drop-target-line{pointer-events:none;position:absolute}:root{--ck-clipboard-drop-target-dot-width:12px;--ck-clipboard-drop-target-dot-height:8px;--ck-clipboard-drop-target-color:var(--ck-color-focus-border)}.ck.ck-editor__editable .ck.ck-clipboard-drop-target-position span{background:var(--ck-clipboard-drop-target-color);border:1px solid var(--ck-clipboard-drop-target-color);bottom:calc(var(--ck-clipboard-drop-target-dot-height)*-.5);margin-left:-1px;top:calc(var(--ck-clipboard-drop-target-dot-height)*-.5)}.ck.ck-editor__editable .ck.ck-clipboard-drop-target-position span:after{border-color:var(--ck-clipboard-drop-target-color) transparent transparent transparent;border-style:solid;border-width:calc(var(--ck-clipboard-drop-target-dot-height)) calc(var(--ck-clipboard-drop-target-dot-width)*.5) 0 calc(var(--ck-clipboard-drop-target-dot-width)*.5);content:"";display:block;height:0;left:50%;position:absolute;top:calc(var(--ck-clipboard-drop-target-dot-height)*-.5);transform:translateX(-50%);width:0}.ck.ck-editor__editable .ck-widget.ck-clipboard-drop-target-range{outline:var(--ck-widget-outline-thickness) solid var(--ck-clipboard-drop-target-color)!important}.ck.ck-editor__editable .ck-widget:-webkit-drag{zoom:.6;outline:none!important}.ck.ck-clipboard-drop-target-line{background:var(--ck-clipboard-drop-target-color);border:1px solid var(--ck-clipboard-drop-target-color);height:0;margin-top:-1px}');
/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */
class T extends e{static get pluginName(){return"DragDrop"}static get requires(){return[w,m]}init(){const e=this.editor,t=e.editing.view;this._draggedRange=null,this._draggingUid="",this._draggableElement=null,this._updateDropMarkerThrottled=b((e=>this._updateDropMarker(e)),40),this._removeDropMarkerDelayed=r((()=>this._removeDropMarker()),40),this._clearDraggableAttributesDelayed=r((()=>this._clearDraggableAttributes()),40),e.plugins.has("DragDropExperimental")?this.forceDisabled("DragDropExperimental"):(t.addObserver(k),t.addObserver(h),this._setupDragging(),this._setupContentInsertionIntegration(),this._setupClipboardInputIntegration(),this._setupDropMarker(),this._setupDraggableAttributeHandling(),this.listenTo(e,"change:isReadOnly",((e,t,r)=>{r?this.forceDisabled("readOnlyMode"):this.clearForceDisabled("readOnlyMode")})),this.on("change:isEnabled",((e,t,r)=>{r||this._finalizeDragging(!1)})),i.isAndroid&&this.forceDisabled("noAndroidSupport"))}destroy(){return this._draggedRange&&(this._draggedRange.detach(),this._draggedRange=null),this._updateDropMarkerThrottled.cancel(),this._removeDropMarkerDelayed.cancel(),this._clearDraggableAttributesDelayed.cancel(),super.destroy()}_setupDragging(){const e=this.editor,t=e.model,r=t.document,n=e.editing.view,a=n.document;this.listenTo(a,"dragstart",((i,n)=>{const s=r.selection;if(n.target&&n.target.is("editableElement"))return void n.preventDefault();const d=n.target?E(n.target):null;if(d){const r=e.editing.mapper.toModelElement(d);if(this._draggedRange=u.fromRange(t.createRangeOn(r)),e.plugins.has("WidgetToolbarRepository")){e.plugins.get("WidgetToolbarRepository").forceDisabled("dragDrop")}}else if(!a.selection.isCollapsed){const e=a.selection.getSelectedElement();e&&f(e)||(this._draggedRange=u.fromRange(s.getFirstRange()))}if(!this._draggedRange)return void n.preventDefault();this._draggingUid=o();const l=this.isEnabled&&e.model.canEditAt(this._draggedRange);n.dataTransfer.effectAllowed=l?"copyMove":"copy",n.dataTransfer.setData("application/ckeditor5-dragging-uid",this._draggingUid);const g=t.createSelection(this._draggedRange.toRange()),c=e.data.toView(t.getSelectedContent(g));a.fire("clipboardOutput",{dataTransfer:n.dataTransfer,content:c,method:"dragstart"}),l||(this._draggedRange.detach(),this._draggedRange=null,this._draggingUid="")}),{priority:"low"}),this.listenTo(a,"dragend",((e,t)=>{this._finalizeDragging(!t.dataTransfer.isCanceled&&"move"==t.dataTransfer.dropEffect)}),{priority:"low"}),this.listenTo(a,"dragenter",(()=>{this.isEnabled&&n.focus()})),this.listenTo(a,"dragleave",(()=>{this._removeDropMarkerDelayed()})),this.listenTo(a,"dragging",((t,r)=>{if(!this.isEnabled)return void(r.dataTransfer.dropEffect="none");this._removeDropMarkerDelayed.cancel();const o=y(e,r.targetRanges,r.target);e.model.canEditAt(o)?(this._draggedRange||(r.dataTransfer.dropEffect="copy"),i.isGecko||("copy"==r.dataTransfer.effectAllowed?r.dataTransfer.dropEffect="copy":["all","copyMove"].includes(r.dataTransfer.effectAllowed)&&(r.dataTransfer.dropEffect="move"))
/* istanbul ignore else -- @preserve */,o&&this._updateDropMarkerThrottled(o)):r.dataTransfer.dropEffect="none"}),{priority:"low"})}_setupClipboardInputIntegration(){const e=this.editor,t=e.editing.view.document;this.listenTo(t,"clipboardInput",((t,r)=>{if("drop"!=r.method)return;const i=y(e,r.targetRanges,r.target);
/* istanbul ignore if -- @preserve */
if(this._removeDropMarker(),!i||!e.model.canEditAt(i))return this._finalizeDragging(!1),void t.stop();this._draggedRange&&this._draggingUid!=r.dataTransfer.getData("application/ckeditor5-dragging-uid")&&(this._draggedRange.detach(),this._draggedRange=null,this._draggingUid="");if("move"==R(r.dataTransfer)&&this._draggedRange&&this._draggedRange.containsRange(i,!0))return this._finalizeDragging(!1),void t.stop();r.targetRanges=[e.editing.mapper.toViewRange(i)]}),{priority:"high"})}_setupContentInsertionIntegration(){const e=this.editor.plugins.get(w);e.on("contentInsertion",((e,t)=>{if(!this.isEnabled||"drop"!==t.method)return;const r=t.targetRanges.map((e=>this.editor.editing.mapper.toModelRange(e)));this.editor.model.change((e=>e.setSelection(r)))}),{priority:"high"}),e.on("contentInsertion",((e,t)=>{if(!this.isEnabled||"drop"!==t.method)return;const r="move"==R(t.dataTransfer),i=!t.resultRange||!t.resultRange.isCollapsed;this._finalizeDragging(i&&r)}),{priority:"lowest"})}_setupDraggableAttributeHandling(){const e=this.editor,t=e.editing.view,r=t.document;this.listenTo(r,"mousedown",((o,n)=>{if(i.isAndroid||!n)return;this._clearDraggableAttributesDelayed.cancel();let a=E(n.target);if(i.isBlink&&!a&&!r.selection.isCollapsed){const e=r.selection.getSelectedElement();if(!e||!f(e)){const e=r.selection.editableElement;e&&!e.isReadOnly&&(a=e)}}a&&(t.change((e=>{e.setAttribute("draggable","true",a)})),this._draggableElement=e.editing.mapper.toModelElement(a))})),this.listenTo(r,"mouseup",(()=>{i.isAndroid||this._clearDraggableAttributesDelayed()}))}_clearDraggableAttributes(){const e=this.editor.editing;e.view.change((t=>{this._draggableElement&&"$graveyard"!=this._draggableElement.root.rootName&&t.removeAttribute("draggable",e.mapper.toViewElement(this._draggableElement)),this._draggableElement=null}))}_setupDropMarker(){const e=this.editor;e.conversion.for("editingDowncast").markerToHighlight({model:"drop-target",view:{classes:["ck-clipboard-drop-target-range"]}}),e.conversion.for("editingDowncast").markerToElement({model:"drop-target",view:(t,{writer:r})=>{if(e.model.schema.checkChild(t.markerRange.start,"$text"))return r.createUIElement("span",{class:"ck ck-clipboard-drop-target-position"},(function(e){const t=this.toDomElement(e);return t.append("⁠",e.createElement("span"),"⁠"),t}))}})}_updateDropMarker(e){const t=this.editor,r=t.model.markers;t.model.change((t=>{r.has("drop-target")?r.get("drop-target").getRange().isEqual(e)||t.updateMarker("drop-target",{range:e}):t.addMarker("drop-target",{range:e,usingOperation:!1,affectsData:!1})}))}_removeDropMarker(){const e=this.editor.model;this._removeDropMarkerDelayed.cancel(),this._updateDropMarkerThrottled.cancel(),e.markers.has("drop-target")&&e.change((e=>{e.removeMarker("drop-target")}))}_finalizeDragging(e){const t=this.editor,r=t.model;if(this._removeDropMarker(),this._clearDraggableAttributes(),t.plugins.has("WidgetToolbarRepository")){t.plugins.get("WidgetToolbarRepository").clearForceDisabled("dragDrop")}this._draggingUid="",this._draggedRange&&(e&&this.isEnabled&&r.deleteContent(r.createSelection(this._draggedRange),{doNotAutoparagraph:!0}),this._draggedRange.detach(),this._draggedRange=null)}}function y(e,t,r){const o=e.model,n=e.editing.mapper;let a=null;const s=t?t[0].start:null;if(r.is("uiElement")&&(r=r.parent),a=function(e,t){const r=e.model,i=e.editing.mapper;if(f(t))return r.createRangeOn(i.toModelElement(t));if(!t.is("editableElement")){const e=t.findAncestor((e=>f(e)||e.is("editableElement")));if(f(e))return r.createRangeOn(i.toModelElement(e))}return null}(e,r),a)return a;const d=function(e,t){const r=e.editing.mapper,i=e.editing.view,o=r.toModelElement(t);if(o)return o;const n=i.createPositionBefore(t),a=r.findMappedViewAncestor(n);return r.toModelElement(a)}(e,r),l=s?n.toModelPosition(s):null;return l?(a=function(e,t,r){const i=e.model;if(!i.schema.checkChild(r,"$block"))return null;const o=i.createPositionAt(r,0),n=t.path.slice(0,o.path.length),a=i.createPositionFromPath(t.root,n),s=a.nodeAfter;if(s&&i.schema.isObject(s))return i.createRangeOn(s);return null}(e,l,d),a||(a=o.schema.getNearestSelectionRange(l,i.isGecko?"forward":"backward"),a||function(e,t){const r=e.model;let i=t;for(;i;){if(r.schema.isObject(i))return r.createRangeOn(i);i=i.parent}
/* istanbul ignore next -- @preserve */return null}(e,l.parent))):function(e,t){const r=e.model,i=r.schema,o=r.createPositionAt(t,0);return i.getNearestSelectionRange(o,"forward")}(e,d)}function R(e){return i.isGecko?e.dropEffect:["all","copyMove"].includes(e.effectAllowed)?"move":"copy"}function E(e){if(e.is("editableElement"))return null;if(e.hasClass("ck-widget__selection-handle"))return e.findAncestor(f);if(f(e))return e;const t=e.findAncestor((e=>f(e)||e.is("editableElement")));return f(t)?t:null}
/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */class M extends e{static get pluginName(){return"PastePlainText"}static get requires(){return[w]}init(){const e=this.editor,t=e.model,r=e.editing.view,i=r.document,o=t.document.selection;let n=!1;r.addObserver(k),this.listenTo(i,"keydown",((e,t)=>{n=t.shiftKey})),e.plugins.get(w).on("contentInsertion",((e,r)=>{(n||function(e,t){if(e.childCount>1)return!1;const r=e.getChild(0);if(t.isObject(r))return!1;return 0==Array.from(r.getAttributeKeys()).length}
/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */(r.content,t.schema))&&t.change((e=>{const i=Array.from(o.getAttributes()).filter((([e])=>t.schema.getAttributeProperties(e).isFormatting));o.isCollapsed||t.deleteContent(o,{doNotAutoparagraph:!0}),i.push(...o.getAttributes());const n=e.createRangeIn(r.content);for(const t of n.getItems())t.is("$textProxy")&&e.setAttributes(i,t)}))}))}}class A extends e{static get pluginName(){return"Clipboard"}static get requires(){return[w,T,M]}}
/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */const C=n("px");class x extends _{constructor(){super();const e=this.bindTemplate;this.set({isVisible:!1,left:null,top:null,width:null}),this.setTemplate({tag:"div",attributes:{class:["ck","ck-clipboard-drop-target-line",e.if("isVisible","ck-hidden",(e=>!e))],style:{left:e.to("left",(e=>C(e))),top:e.to("top",(e=>C(e))),width:e.to("width",(e=>C(e)))}}})}}
/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */class P extends e{constructor(){super(...arguments),this.removeDropMarkerDelayed=r((()=>this.removeDropMarker()),40),this._updateDropMarkerThrottled=b((e=>this._updateDropMarker(e)),40),this._reconvertMarkerThrottled=b((()=>{this.editor.model.markers.has("drop-target")&&this.editor.editing.reconvertMarker("drop-target")}),0),this._dropTargetLineView=new x,this._domEmitter=new(a()),this._scrollables=new Map}static get pluginName(){return"DragDropTarget"}init(){this._setupDropMarker()}destroy(){this._domEmitter.stopListening();for(const{resizeObserver:e}of this._scrollables.values())e.destroy();return this._updateDropMarkerThrottled.cancel(),this.removeDropMarkerDelayed.cancel(),this._reconvertMarkerThrottled.cancel(),super.destroy()}updateDropMarker(e,t,r,i,o){this.removeDropMarkerDelayed.cancel();const n=O(this.editor,e,t,r,i,o);
/* istanbul ignore else -- @preserve */n&&this._updateDropMarkerThrottled(n)}getFinalDropRange(e,t,r,i,o){const n=O(this.editor,e,t,r,i,o);return this.removeDropMarker(),n}removeDropMarker(){const e=this.editor.model;this.removeDropMarkerDelayed.cancel(),this._updateDropMarkerThrottled.cancel(),this._dropTargetLineView.isVisible=!1,e.markers.has("drop-target")&&e.change((e=>{e.removeMarker("drop-target")}))}_setupDropMarker(){const e=this.editor;e.ui.view.body.add(this._dropTargetLineView),e.conversion.for("editingDowncast").markerToHighlight({model:"drop-target",view:{classes:["ck-clipboard-drop-target-range"]}}),e.conversion.for("editingDowncast").markerToElement({model:"drop-target",view:(t,{writer:r})=>{if(e.model.schema.checkChild(t.markerRange.start,"$text"))return this._dropTargetLineView.isVisible=!1,this._createDropTargetPosition(r);t.markerRange.isCollapsed?this._updateDropTargetLine(t.markerRange):this._dropTargetLineView.isVisible=!1}})}_updateDropMarker(e){const t=this.editor,r=t.model.markers;t.model.change((t=>{r.has("drop-target")?r.get("drop-target").getRange().isEqual(e)||t.updateMarker("drop-target",{range:e}):t.addMarker("drop-target",{range:e,usingOperation:!1,affectsData:!1})}))}_createDropTargetPosition(e){return e.createUIElement("span",{class:"ck ck-clipboard-drop-target-position"},(function(e){const t=this.toDomElement(e);return t.append("⁠",e.createElement("span"),"⁠"),t}))}_updateDropTargetLine(e){const t=this.editor.editing,r=e.start.nodeBefore,i=e.start.nodeAfter,o=e.start.parent,n=r?t.mapper.toViewElement(r):null,a=n?t.view.domConverter.mapViewToDom(n):null,l=i?t.mapper.toViewElement(i):null,g=l?t.view.domConverter.mapViewToDom(l):null,c=t.mapper.toViewElement(o),p=t.view.domConverter.mapViewToDom(c),h=this._getScrollableRect(c),{scrollX:u,scrollY:m}=s.window,f=a?new d(a):null,b=g?new d(g):null,_=new d(p).excludeScrollbarsAndBorders(),k=f?f.bottom:_.top,D=b?b.top:_.bottom,v=s.window.getComputedStyle(p),w=k<=D?(k+D)/2:D;if(h.top<w&&w<h.bottom){const e=_.left+parseFloat(v.paddingLeft),t=_.right-parseFloat(v.paddingRight),r=Math.max(e+u,h.left),i=Math.min(t+u,h.right);this._dropTargetLineView.set({isVisible:!0,left:r,top:w+m,width:i-r})}else this._dropTargetLineView.isVisible=!1}_getScrollableRect(e){const t=e.root.rootName;let r;if(this._scrollables.has(t))r=this._scrollables.get(t).domElement;else{r=function(e){let t=e;do{t=t.parentElement;const e=s.window.getComputedStyle(t).overflowY;if("auto"==e||"scroll"==e)break}while("BODY"!=t.tagName);return t}
/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */(this.editor.editing.view.domConverter.mapViewToDom(e)),this._domEmitter.listenTo(r,"scroll",this._reconvertMarkerThrottled,{usePassive:!0});const i=new l(r,this._reconvertMarkerThrottled);this._scrollables.set(t,{domElement:r,resizeObserver:i})}return new d(r).excludeScrollbarsAndBorders()}}function O(e,t,r,i,o,n){const a=e.model,s=e.editing.mapper,d=B(e,t);let l=d;for(;l;){if(!n)if(a.schema.checkChild(l,"$text")){const t=r?r[0].start:null,n=t?s.toModelPosition(t):null;if(n){if(a.schema.checkChild(n,"$text"))return a.createRange(n);if(t)return I(e,B(e,t.parent),i,o)}}else if(a.schema.isInline(l))return I(e,l,i,o);if(a.schema.isBlock(l))return I(e,l,i,o);if(a.schema.checkChild(l,"$block")){const t=Array.from(l.getChildren()).filter((t=>t.is("element")&&!V(e,t)));let r=0,n=t.length;for(;r<n-1;){const a=Math.floor((r+n)/2);"before"==S(e,t[a],i,o)?n=a:r=a}return I(e,t[r],i,o)}l=l.parent}return console.warn("none:",d.name),null}function V(e,t){const r=e.editing.mapper,i=e.editing.view.domConverter,o=r.toViewElement(t),n=i.mapViewToDom(o);return"none"!=s.window.getComputedStyle(n).float}function I(e,t,r,i){const o=e.model;return o.createRange(o.createPositionAt(t,S(e,t,r,i)))}function S(e,t,r,i){const o=e.editing.mapper,n=e.editing.view.domConverter,a=o.toViewElement(t),s=n.mapViewToDom(a),l=new d(s);return e.model.schema.isInline(t)?r<(l.left+l.right)/2?"before":"after":i<(l.top+l.bottom)/2?"before":"after"}function B(e,t){const r=e.editing.mapper,i=e.editing.view,o=r.toModelElement(t);if(o)return o;const n=i.createPositionBefore(t),a=r.findMappedViewAncestor(n);return r.toModelElement(a)}class N extends e{constructor(){super(...arguments),this._clearDraggableAttributesDelayed=r((()=>this._clearDraggableAttributes()),40),this._blockMode=!1,this._domEmitter=new(a())}static get pluginName(){return"DragDropExperimental"}static get requires(){return[w,m,P]}init(){const e=this.editor,t=e.editing.view;this._draggedRange=null,this._draggingUid="",this._draggableElement=null,t.addObserver(k),t.addObserver(h),this._setupDragging(),this._setupContentInsertionIntegration(),this._setupClipboardInputIntegration(),this._setupDraggableAttributeHandling(),this.listenTo(e,"change:isReadOnly",((e,t,r)=>{r?this.forceDisabled("readOnlyMode"):this.clearForceDisabled("readOnlyMode")})),this.on("change:isEnabled",((e,t,r)=>{r||this._finalizeDragging(!1)})),i.isAndroid&&this.forceDisabled("noAndroidSupport")}destroy(){return this._draggedRange&&(this._draggedRange.detach(),this._draggedRange=null),this._previewContainer&&this._previewContainer.remove(),this._domEmitter.stopListening(),this._clearDraggableAttributesDelayed.cancel(),super.destroy()}_setupDragging(){const e=this.editor,t=e.model,r=e.editing.view,n=r.document,a=e.plugins.get(P);this.listenTo(n,"dragstart",((r,i)=>{if(i.target&&i.target.is("editableElement"))return void i.preventDefault();if(this._prepareDraggedRange(i.target),!this._draggedRange)return void i.preventDefault();this._draggingUid=o(),i.dataTransfer.effectAllowed=this.isEnabled?"copyMove":"copy",i.dataTransfer.setData("application/ckeditor5-dragging-uid",this._draggingUid);const a=t.createSelection(this._draggedRange.toRange()),s=e.data.toView(t.getSelectedContent(a));n.fire("clipboardOutput",{dataTransfer:i.dataTransfer,content:s,method:"dragstart"}),this._updatePreview(i.dataTransfer),i.stopPropagation(),this.isEnabled||(this._draggedRange.detach(),this._draggedRange=null,this._draggingUid="")}),{priority:"low"}),this.listenTo(n,"dragend",((e,t)=>{this._finalizeDragging(!t.dataTransfer.isCanceled&&"move"==t.dataTransfer.dropEffect)}),{priority:"low"}),this._domEmitter.listenTo(s.document,"dragend",(()=>{this._blockMode=!1}),{useCapture:!0}),this.listenTo(n,"dragenter",(()=>{this.isEnabled&&r.focus()})),this.listenTo(n,"dragleave",(()=>{a.removeDropMarkerDelayed()})),this.listenTo(n,"dragging",((e,t)=>{if(!this.isEnabled)return void(t.dataTransfer.dropEffect="none");const{clientX:r,clientY:o}=t.domEvent;a.updateDropMarker(t.target,t.targetRanges,r,o,this._blockMode),this._draggedRange||(t.dataTransfer.dropEffect="copy"),i.isGecko||("copy"==t.dataTransfer.effectAllowed?t.dataTransfer.dropEffect="copy":["all","copyMove"].includes(t.dataTransfer.effectAllowed)&&(t.dataTransfer.dropEffect="move")),e.stop()}),{priority:"low"})}_setupClipboardInputIntegration(){const e=this.editor,t=e.editing.view.document,r=e.plugins.get(P);this.listenTo(t,"clipboardInput",((t,i)=>{if("drop"!=i.method)return;const{clientX:o,clientY:n}=i.domEvent,a=r.getFinalDropRange(i.target,i.targetRanges,o,n,this._blockMode);
/* istanbul ignore if -- @preserve */
if(!a)return this._finalizeDragging(!1),void t.stop();this._draggedRange&&this._draggingUid!=i.dataTransfer.getData("application/ckeditor5-dragging-uid")&&(this._draggedRange.detach(),this._draggedRange=null,this._draggingUid="");if("move"==F(i.dataTransfer)&&this._draggedRange&&this._draggedRange.containsRange(a,!0))return this._finalizeDragging(!1),void t.stop();i.targetRanges=[e.editing.mapper.toViewRange(a)]}),{priority:"high"})}_setupContentInsertionIntegration(){const e=this.editor.plugins.get(w);e.on("contentInsertion",((e,t)=>{if(!this.isEnabled||"drop"!==t.method)return;const r=t.targetRanges.map((e=>this.editor.editing.mapper.toModelRange(e)));this.editor.model.change((e=>e.setSelection(r)))}),{priority:"high"}),e.on("contentInsertion",((e,t)=>{if(!this.isEnabled||"drop"!==t.method)return;const r="move"==F(t.dataTransfer),i=!t.resultRange||!t.resultRange.isCollapsed;this._finalizeDragging(i&&r)}),{priority:"lowest"})}_setupDraggableAttributeHandling(){const e=this.editor,t=e.editing.view,r=t.document;this.listenTo(r,"mousedown",((o,n)=>{if(i.isAndroid||!n)return;this._clearDraggableAttributesDelayed.cancel();let a=U(n.target);if(i.isBlink&&!e.isReadOnly&&!a&&!r.selection.isCollapsed){const e=r.selection.getSelectedElement();e&&f(e)||(a=r.selection.editableElement)}a&&(t.change((e=>{e.setAttribute("draggable","true",a)})),this._draggableElement=e.editing.mapper.toModelElement(a))})),this.listenTo(r,"mouseup",(()=>{i.isAndroid||this._clearDraggableAttributesDelayed()}))}_clearDraggableAttributes(){const e=this.editor.editing;e.view.change((t=>{this._draggableElement&&"$graveyard"!=this._draggableElement.root.rootName&&t.removeAttribute("draggable",e.mapper.toViewElement(this._draggableElement)),this._draggableElement=null}))}_finalizeDragging(e){const t=this.editor,r=t.model;if(t.plugins.get(P).removeDropMarker(),this._clearDraggableAttributes(),t.plugins.has("WidgetToolbarRepository")){t.plugins.get("WidgetToolbarRepository").clearForceDisabled("dragDrop")}this._draggingUid="",this._previewContainer&&(this._previewContainer.remove(),this._previewContainer=void 0),this._draggedRange&&(e&&this.isEnabled&&r.deleteContent(r.createSelection(this._draggedRange),{doNotAutoparagraph:!0}),this._draggedRange.detach(),this._draggedRange=null)}_prepareDraggedRange(e){const t=this.editor,r=t.model,i=r.document.selection,o=e?U(e):null;if(o){const e=t.editing.mapper.toModelElement(o);if(this._draggedRange=u.fromRange(r.createRangeOn(e)),this._blockMode=r.schema.isBlock(e),t.plugins.has("WidgetToolbarRepository")){t.plugins.get("WidgetToolbarRepository").forceDisabled("dragDrop")}}else if(!i.isCollapsed||i.getFirstPosition().parent.isEmpty){const e=Array.from(i.getSelectedBlocks());if(e.length>1)this._draggedRange=u.fromRange(r.createRange(r.createPositionBefore(e[0]),r.createPositionAfter(e[e.length-1]))),r.change((e=>e.setSelection(this._draggedRange.toRange()))),this._blockMode=!0;else if(1==e.length){const t=i.getFirstRange(),o=r.createRange(r.createPositionBefore(e[0]),r.createPositionAfter(e[0]));t.start.isTouching(o.start)&&t.end.isTouching(o.end)?(this._draggedRange=u.fromRange(o),this._blockMode=!0):(this._draggedRange=u.fromRange(i.getFirstRange()),this._blockMode=!1)}}}_updatePreview(e){const t=this.editor.editing.view,r=t.document.selection.editableElement,i=t.domConverter.mapViewToDom(r),o=s.window.getComputedStyle(i);this._previewContainer?this._previewContainer.removeChild(this._previewContainer.firstElementChild):(this._previewContainer=g(s.document,"div",{style:"position: fixed; left: -999999px;"}),s.document.body.appendChild(this._previewContainer));const n=g(s.document,"div");n.className="ck ck-content",n.style.width=o.width,n.innerHTML=e.getData("text/html"),e.setDragImage(n,0,0),this._previewContainer.appendChild(n)}}function F(e){return i.isGecko?e.dropEffect:["all","copyMove"].includes(e.effectAllowed)?"move":"copy"}function U(e){if(e.is("editableElement"))return null;if(e.hasClass("ck-widget__selection-handle"))return e.findAncestor(f);if(f(e))return e;const t=e.findAncestor((e=>f(e)||e.is("editableElement")));return f(t)?t:null}
/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */class z extends e{constructor(){super(...arguments),this._isBlockDragging=!1,this._domEmitter=new(a())}static get pluginName(){return"DragDropBlockToolbar"}init(){const e=this.editor;if(this.listenTo(e,"change:isReadOnly",((e,t,r)=>{r?(this.forceDisabled("readOnlyMode"),this._isBlockDragging=!1):this.clearForceDisabled("readOnlyMode")})),i.isAndroid&&this.forceDisabled("noAndroidSupport"),e.plugins.has("BlockToolbar")){const t=e.plugins.get("BlockToolbar").buttonView.element;t.setAttribute("draggable","true"),this._domEmitter.listenTo(t,"dragstart",((e,t)=>this._handleBlockDragStart(t))),this._domEmitter.listenTo(s.document,"dragover",((e,t)=>this._handleBlockDragging(t))),this._domEmitter.listenTo(s.document,"drop",((e,t)=>this._handleBlockDragging(t))),this._domEmitter.listenTo(s.document,"dragend",(()=>this._handleBlockDragEnd()),{useCapture:!0})}}destroy(){return this._domEmitter.stopListening(),super.destroy()}_handleBlockDragStart(e){if(!this.isEnabled)return;const t=this.editor.model,r=t.document.selection,i=Array.from(r.getSelectedBlocks()),o=t.createRange(t.createPositionBefore(i[0]),t.createPositionAfter(i[i.length-1]));t.change((e=>e.setSelection(o))),this._isBlockDragging=!0,this.editor.editing.view.getObserver(k).onDomEvent(e)}_handleBlockDragging(e){if(!this.isEnabled||!this._isBlockDragging)return;const t=e.clientX+100,r=e.clientY,i=document.elementFromPoint(t,r);i&&i.closest(".ck-editor__editable")&&this.editor.editing.view.getObserver(k).onDomEvent({...e,type:e.type,dataTransfer:e.dataTransfer,target:i,clientX:t,clientY:r,preventDefault:()=>e.preventDefault(),stopPropagation:()=>e.stopPropagation()})}_handleBlockDragEnd(){this._isBlockDragging=!1}}export{A as Clipboard,w as ClipboardPipeline,T as DragDrop,z as DragDropBlockToolbar,N as DragDropExperimental,P as DragDropTarget,M as PastePlainText};