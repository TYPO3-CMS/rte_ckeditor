/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
var __decorate=function(t,e,o,r){var i,n=arguments.length,s=n<3?e:null===r?r=Object.getOwnPropertyDescriptor(e,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,o,r);else for(var l=t.length-1;l>=0;l--)(i=t[l])&&(s=(n<3?i(s):n>3?i(e,o,s):i(e,o))||s);return n>3&&s&&Object.defineProperty(e,o,s),s};import{html,LitElement}from"lit";import{customElement,property,query}from"lit/decorators.js";import AjaxRequest from"@typo3/core/ajax/ajax-request.js";import{prefixAndRebaseCss}from"@typo3/rte-ckeditor/css-prefixer.js";import{ClassicEditor}from"@ckeditor/ckeditor5-editor-classic";const defaultPlugins=[{module:"@ckeditor/ckeditor5-block-quote",exports:["BlockQuote"]},{module:"@ckeditor/ckeditor5-essentials",exports:["Essentials"]},{module:"@ckeditor/ckeditor5-find-and-replace",exports:["FindAndReplace"]},{module:"@ckeditor/ckeditor5-heading",exports:["Heading"]},{module:"@ckeditor/ckeditor5-indent",exports:["Indent"]},{module:"@ckeditor/ckeditor5-link",exports:["Link"]},{module:"@ckeditor/ckeditor5-list",exports:["DocumentList"]},{module:"@ckeditor/ckeditor5-paragraph",exports:["Paragraph"]},{module:"@ckeditor/ckeditor5-clipboard",exports:["PastePlainText"]},{module:"@ckeditor/ckeditor5-paste-from-office",exports:["PasteFromOffice"]},{module:"@ckeditor/ckeditor5-remove-format",exports:["RemoveFormat"]},{module:"@ckeditor/ckeditor5-table",exports:["Table","TableToolbar","TableProperties","TableCellProperties"]},{module:"@ckeditor/ckeditor5-typing",exports:["TextTransformation"]},{module:"@ckeditor/ckeditor5-source-editing",exports:["SourceEditing"]},{module:"@ckeditor/ckeditor5-alignment",exports:["Alignment"]},{module:"@ckeditor/ckeditor5-style",exports:["Style"]},{module:"@ckeditor/ckeditor5-html-support",exports:["GeneralHtmlSupport"]},{module:"@ckeditor/ckeditor5-basic-styles",exports:["Bold","Italic","Subscript","Superscript","Strikethrough","Underline"]},{module:"@ckeditor/ckeditor5-special-characters",exports:["SpecialCharacters","SpecialCharactersEssentials"]},{module:"@ckeditor/ckeditor5-horizontal-line",exports:["HorizontalLine"]}];let CKEditor5Element=class extends LitElement{constructor(){super(...arguments),this.options={},this.formEngine={},this.styleSheets=new Map}connectedCallback(){if(super.connectedCallback(),Array.isArray(this.options.contentsCss))for(const t of this.options.contentsCss)this.prefixAndLoadContentsCss(t,this.getAttribute("id"))}disconnectedCallback(){super.disconnectedCallback(),document.adoptedStyleSheets=document.adoptedStyleSheets.filter((t=>!this.styleSheets.has(t))),this.styleSheets.clear()}async firstUpdated(){if(!(this.target instanceof HTMLElement))throw new Error("No rich-text content target found.");const t=normalizeImportModules(this.options.removeImportModules||[]),e=normalizeImportModules([...defaultPlugins,...this.options.importModules||[]]).map((e=>{const{module:o}=e;let{exports:r}=e;for(const e of t)e.module===o&&(r=r.filter((t=>!e.exports.includes(t))));return{module:o,exports:r}})),o=await Promise.all(e.map((async t=>{try{return{module:await import(t.module),exports:t.exports}}catch(e){return console.error(`Failed to load CKEditor5 module ${t.module}`,e),{module:null,exports:[]}}}))),r=[];o.forEach((({module:t,exports:e})=>{for(const o of e)o in t?r.push(t[o]):console.error(`CKEditor5 plugin export "${o}" not available in`,t)}));const i=r.filter((t=>t.overrides?.length>0)).map((t=>t.overrides)).flat(1),n=r.filter((t=>!i.includes(t))),s={toolbar:this.options.toolbar,plugins:n,typo3link:this.options.typo3link||null,removePlugins:this.options.removePlugins||[]};this.options.language&&(s.language=this.options.language),this.options.style&&(s.style=this.options.style),this.options.wordCount&&(s.wordCount=this.options.wordCount),this.options.table&&(s.table=this.options.table),this.options.heading&&(s.heading=this.options.heading),this.options.alignment&&(s.alignment=this.options.alignment),this.options.ui&&(s.ui=this.options.ui),this.options.htmlSupport&&(s.htmlSupport=convertPseudoRegExp(this.options.htmlSupport)),ClassicEditor.create(this.target,s).then((t=>{if(this.applyEditableElementStyles(t),this.handleWordCountPlugin(t),this.applyReadOnly(t),t.plugins.has("SourceEditing")){const e=t.plugins.get("SourceEditing");t.model.document.on("change:data",(()=>{e.isSourceEditingMode||t.updateSourceElement(),this.target.dispatchEvent(new Event("change",{bubbles:!0,cancelable:!0}))}))}this.options.debug&&import("@ckeditor/ckeditor5-inspector").then((({default:e})=>e.attach(t,{isCollapsed:!0})))}))}createRenderRoot(){return this}render(){return html`
      <textarea
        id="${this.formEngine.id}"
        name="${this.formEngine.name}"
        class="form-control"
        rows="18"
        data-formengine-validation-rules="${this.formEngine.validationRules}"
        >${this.formEngine.value}</textarea>
    `}async prefixAndLoadContentsCss(t,e){let o;try{const e=await new AjaxRequest(t).get();o=await e.resolve()}catch{return}const r=prefixAndRebaseCss(o,t,`#${e} .ck-content`),i=new CSSStyleSheet;await i.replace(r),this.styleSheets.set(i,!0),document.adoptedStyleSheets=[...document.adoptedStyleSheets,i]}applyEditableElementStyles(t){const e=t.editing.view,o={"min-height":this.options.height,"min-width":this.options.width};Object.keys(o).forEach((t=>{let r=o[t];r&&(isFinite(r)&&!Number.isNaN(parseFloat(r))&&(r+="px"),e.change((o=>{o.setStyle(t,r,e.document.getRoot())})))}))}handleWordCountPlugin(t){if(t.plugins.has("WordCount")&&(this.options?.wordCount?.displayWords||this.options?.wordCount?.displayCharacters)){const e=t.plugins.get("WordCount");this.renderRoot.appendChild(e.wordCountContainer)}}applyReadOnly(t){this.options.readOnly&&t.enableReadOnlyMode("typo3-lock")}};__decorate([property({type:Object})],CKEditor5Element.prototype,"options",void 0),__decorate([property({type:Object,attribute:"form-engine"})],CKEditor5Element.prototype,"formEngine",void 0),__decorate([query("textarea")],CKEditor5Element.prototype,"target",void 0),CKEditor5Element=__decorate([customElement("typo3-rte-ckeditor-ckeditor5")],CKEditor5Element);export{CKEditor5Element};function walkObj(t,e){if("object"==typeof t){if(Array.isArray(t))return t.map((t=>e(t)??walkObj(t,e)));const o={};for(const[r,i]of Object.entries(t))o[r]=e(i)??walkObj(i,e);return o}return t}function convertPseudoRegExp(t){return walkObj(t,(t=>{if("object"==typeof t&&"pattern"in t&&"string"==typeof t.pattern){const e=t;return new RegExp(e.pattern,e.flags||void 0)}return null}))}function normalizeImportModules(t){return t.map((t=>"string"==typeof t?{module:t,exports:["default"]}:t))}